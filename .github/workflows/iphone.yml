name: ğŸ Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Permette di avviare manualmente dalla UI GitHub

jobs:
  build-ios:
    name: ğŸ“± Build iOS (.app file)
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.4'
        channel: 'stable'
        cache: true
        
    - name: ğŸ” Flutter doctor
      run: flutter doctor -v
      
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: ğŸ” Analyze code
      run: flutter analyze
      
    - name: ğŸ§ª Run tests
      run: flutter test || echo "âš ï¸ No tests found or tests failed"
      
    - name: ğŸ—ï¸ Build iOS (unsigned for AltStore)
      run: |
        echo "ğŸ”¨ Building iOS app without code signing..."
        flutter build ios --no-codesign --release
        
    - name: ğŸ“± Create .app bundle
      run: |
        echo "ğŸ“¦ Creating .app bundle..."
        cd build/ios/iphoneos/
        ls -la
        mkdir -p ../../../artifacts
        cp -R Runner.app ../../../artifacts/
        echo "âœ… .app bundle created successfully"
        
    - name: ğŸ—œï¸ Compress app for download
      run: |
        cd artifacts
        echo "ğŸ—œï¸ Compressing app..."
        zip -r "iOS-App-Accessibile-$(date +%Y%m%d-%H%M%S).zip" Runner.app
        ls -la
        echo "âœ… App compressed successfully"
        
    - name: ğŸ“¤ Upload iOS app artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-unsigned
        path: artifacts/
        retention-days: 30
        
    - name: ğŸ“Š Build summary
      run: |
        echo "ğŸ‰ Build completed successfully!"
        echo "ğŸ“± iOS app (.app file) is ready for AltStore installation"
        echo "ğŸ“¥ Download from: Actions â†’ Artifacts â†’ ios-app-unsigned"
        echo "â° Artifact retention: 30 days"