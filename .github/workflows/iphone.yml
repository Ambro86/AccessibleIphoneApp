name: ğŸ Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Permette di avviare manualmente dalla UI GitHub

jobs:
  build-ios:
    name: ğŸ“± Build iOS (.ipa file)
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.4'
        channel: 'stable'
        cache: true
        
    - name: ğŸ” Flutter doctor
      run: flutter doctor -v
      
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: ğŸ” Analyze code
      run: flutter analyze
      
    - name: ğŸ§ª Run tests
      run: flutter test || echo "âš ï¸ No tests found or tests failed"
      
    - name: ğŸ—ï¸ Build iOS (unsigned for AltStore)
      run: |
        echo "ğŸ”¨ Building iOS app without code signing..."
        flutter build ios --no-codesign --release
        
    - name: ğŸ“± Create .ipa file (iOS App Package)
      run: |
        echo "ğŸ“¦ Creating .ipa file for AltStore..."
        cd build/ios/iphoneos/
        
        # Crea la struttura Payload per .ipa
        mkdir -p Payload
        cp -R Runner.app Payload/
        
        # Crea il file .ipa (Ã¨ sostanzialmente un file ZIP con estensione .ipa)
        zip -r "AccessibleIphoneApp-unsigned.ipa" Payload/
        
        # Sposta nella cartella artifacts
        mkdir -p ../../../artifacts
        mv AccessibleIphoneApp-unsigned.ipa ../../../artifacts/
        
        # Verifica che sia stato creato
        ls -la ../../../artifacts/
        echo "âœ… .ipa file created successfully"
        
    - name: ğŸ“‹ Create installation info
      run: |
        mkdir -p artifacts
        cd artifacts
        echo "ğŸ“‹ Creating installation instructions..."
        cat > INSTALL_INSTRUCTIONS.txt << 'INSTALL_EOF'
        # ğŸ“± Installazione App iOS Accessibile

        ## ğŸ”§ Requisiti:
        - iPhone/iPad con iOS 14.0+
        - AltStore installato sul dispositivo
        - Computer con AltServer

        ## ğŸ“¥ Installazione:

        ### Metodo 1: AltStore (Consigliato)
        1. Scarica il file .ipa
        2. Apri AltStore sul tuo iPhone
        3. Tocca il pulsante "+" in alto a sinistra
        4. Seleziona il file .ipa scaricato
        5. Inserisci Apple ID e password quando richiesto
        6. Attendi l'installazione

        ### Metodo 2: Sideloadly / 3uTools
        1. Collega iPhone al computer
        2. Apri Sideloadly
        3. Trascina il file .ipa nell'app
        4. Inserisci le credenziali Apple ID
        5. Avvia l'installazione

        ## âš ï¸ Note Importanti:
        - L'app scadrÃ  dopo 7 giorni (account gratuito)
        - Rinnovare settimanalmente tramite AltStore
        - Autorizzare lo sviluppatore in Impostazioni > Generali > Gestione dispositivi

        ## ğŸ”„ Rinnovo automatico:
        - Tieni AltStore aperto in background
        - Connetti il dispositivo alla stessa rete WiFi del computer con AltServer

        ## ğŸ“ Supporto:
        - Problemi di installazione: verifica che AltServer sia in esecuzione
        - App non si apre: autorizza lo sviluppatore nelle impostazioni iOS

        Build: $(date +%Y%m%d-%H%M%S)
        INSTALL_EOF
        
        echo "âœ… Installation guide created"
        
    - name: ğŸ“¤ Upload iOS .ipa file
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa-unsigned
        path: artifacts/
        retention-days: 30
        
    - name: ğŸ“Š Build summary
      run: |
        echo "ğŸ‰ Build completed successfully!"
        echo "ğŸ“± iOS .ipa file is ready for AltStore/Sideloadly installation"
        echo "ğŸ“¥ Download from: Actions â†’ Artifacts â†’ ios-ipa-unsigned"
        echo "ğŸ“‹ Installation instructions included in download"
        echo "â° Artifact retention: 30 days"
 