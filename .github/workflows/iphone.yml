name: 🍎 Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Permette di avviare manualmente dalla UI GitHub

jobs:
  build-ios:
    name: 📱 Build iOS (.ipa file)
    runs-on: macos-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      
    - name: 🐦 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.4'
        channel: 'stable'
        cache: true
        
    - name: 🔍 Flutter doctor
      run: flutter doctor -v
      
    - name: 📦 Get dependencies
      run: flutter pub get
      
    - name: 🔍 Analyze code
      run: flutter analyze
      
    - name: 🧪 Run tests
      run: flutter test || echo "⚠️ No tests found or tests failed"
      
    - name: 🏗️ Build iOS (unsigned for AltStore)
      run: |
        echo "🔨 Building iOS app without code signing..."
        flutter build ios --no-codesign --release
        
    - name: 📱 Create .ipa file (iOS App Package)
      run: |
        echo "📦 Creating .ipa file for AltStore..."
        cd build/ios/iphoneos/
        
        # Crea la struttura Payload per .ipa
        mkdir -p Payload
        cp -R Runner.app Payload/
        
        # Crea il file .ipa (è sostanzialmente un file ZIP con estensione .ipa)
        zip -r "AccessibleIphoneApp-unsigned.ipa" Payload/
        
        # Sposta nella cartella artifacts
        mkdir -p ../../../artifacts
        mv AccessibleIphoneApp-unsigned.ipa ../../../artifacts/
        
        # Verifica che sia stato creato
        ls -la ../../../artifacts/
        echo "✅ .ipa file created successfully"
        
    - name: 📋 Create installation info
      run: |
        mkdir -p artifacts
        cd artifacts
        echo "📋 Creating installation instructions..."
        cat > INSTALL_INSTRUCTIONS.txt << 'INSTALL_EOF'
        # 📱 Installazione App iOS Accessibile

        ## 🔧 Requisiti:
        - iPhone/iPad con iOS 14.0+
        - AltStore installato sul dispositivo
        - Computer con AltServer

        ## 📥 Installazione:

        ### Metodo 1: AltStore (Consigliato)
        1. Scarica il file .ipa
        2. Apri AltStore sul tuo iPhone
        3. Tocca il pulsante "+" in alto a sinistra
        4. Seleziona il file .ipa scaricato
        5. Inserisci Apple ID e password quando richiesto
        6. Attendi l'installazione

        ### Metodo 2: Sideloadly / 3uTools
        1. Collega iPhone al computer
        2. Apri Sideloadly
        3. Trascina il file .ipa nell'app
        4. Inserisci le credenziali Apple ID
        5. Avvia l'installazione

        ## ⚠️ Note Importanti:
        - L'app scadrà dopo 7 giorni (account gratuito)
        - Rinnovare settimanalmente tramite AltStore
        - Autorizzare lo sviluppatore in Impostazioni > Generali > Gestione dispositivi

        ## 🔄 Rinnovo automatico:
        - Tieni AltStore aperto in background
        - Connetti il dispositivo alla stessa rete WiFi del computer con AltServer

        ## 📞 Supporto:
        - Problemi di installazione: verifica che AltServer sia in esecuzione
        - App non si apre: autorizza lo sviluppatore nelle impostazioni iOS

        Build: $(date +%Y%m%d-%H%M%S)
        INSTALL_EOF
        
        echo "✅ Installation guide created"
        
    - name: 📤 Upload iOS .ipa file
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa-unsigned
        path: artifacts/
        retention-days: 30
        
    - name: 📊 Build summary
      run: |
        echo "🎉 Build completed successfully!"
        echo "📱 iOS .ipa file is ready for AltStore/Sideloadly installation"
        echo "📥 Download from: Actions → Artifacts → ios-ipa-unsigned"
        echo "📋 Installation instructions included in download"
        echo "⏰ Artifact retention: 30 days"
 