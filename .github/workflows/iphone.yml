name: Build Web PWA (Works on iPhone!)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-web:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Flet
      run: |
        pip install flet==0.28.3
        pip install flet-cli==0.28.3
    
    - name: Setup main file
      run: |
        if [ -f "gioco.py" ]; then
          echo "MAIN_FILE=gioco.py" >> $GITHUB_ENV
        elif [ -f "main.py" ]; then
          echo "MAIN_FILE=main.py" >> $GITHUB_ENV
        else
          echo "MAIN_FILE=avventura_epica.py" >> $GITHUB_ENV
        fi
    
    - name: Prepare assets
      run: |
        if [ -d "assets" ]; then
          echo "✅ Assets found"
        else
          mkdir -p assets/music
          # Crea file audio placeholder per il web
          for i in {1..20}; do 
            echo "Audio placeholder $i" > "assets/music/$i.wav"
          done
        fi
    
    - name: Build Web PWA
      run: |
        echo "🌐 Building Web PWA with Flet..."
        
        flet build web $MAIN_FILE \
          --name "AvventuraEpica" \
          --description "Avventura Epica - Gioco Accessibile per iPhone/iPad" \
          --base-url "/AccessibleIphoneApp/" \
          --web-renderer "canvaskit" \
          --pwa-background-color "#1976D2" \
          --pwa-theme-color "#1976D2" \
          --route-url-strategy "hash"
        
        echo "✅ Web build completed!"
        ls -la build/web/
    
    - name: Setup GitHub Pages
      run: |
        echo "📱 Configuring for GitHub Pages..."
        
        # Copia tutto nella root per GitHub Pages
        cp -r build/web/* .
        
        # Assicurati che ci sia index.html
        if [ ! -f "index.html" ]; then
          echo "❌ No index.html found!"
          exit 1
        fi
        
        # Crea .nojekyll per GitHub Pages
        touch .nojekyll
        
        # Verifica files
        echo "📂 Files ready for GitHub Pages:"
        ls -la *.html *.js *.css 2>/dev/null || true
        
        echo "🎯 PWA ready! Access via: https://ambro86.github.io/AccessibleIphoneApp/"
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build/web
        publish_branch: gh-pages
        force_orphan: true
    
    - name: Upload Web Build
      uses: actions/upload-artifact@v4
      with:
        name: AvventuraEpica-WebPWA
        path: build/web/
        retention-days: 30
 
 