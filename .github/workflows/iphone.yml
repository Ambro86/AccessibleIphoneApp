name: Build iOS App

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Xcode Command Line Tools
      run: |
        sudo xcode-select --install || true
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer || true
    
    - name: Install Flet and dependencies
      run: |
        pip install flet flet-audio pyinstaller
        pip install --upgrade setuptools wheel
    
    - name: Detect main file
      run: |
        if [ -f "gioco.py" ]; then
          echo "MAIN_FILE=gioco.py" >> $GITHUB_ENV
        elif [ -f "main.py" ]; then
          echo "MAIN_FILE=main.py" >> $GITHUB_ENV
        else
          echo "MAIN_FILE=avventura_epica.py" >> $GITHUB_ENV
        fi
    
    - name: Check assets
      run: |
        echo "Checking for existing assets..."
        if [ -d "assets" ]; then
          echo "Assets folder found:"
          find assets -name "*.wav" -o -name "*.mp3" | sort
          AUDIO_COUNT=$(find assets -name "*.wav" -o -name "*.mp3" | wc -l)
          echo "Total audio files: $AUDIO_COUNT"
        else
          echo "No assets folder found, creating minimal structure..."
          mkdir -p assets
          for i in {1..18}; do touch "assets/$i.wav"; done
          echo "Created placeholder files 1.wav to 18.wav"
        fi
    
    - name: Create Info.plist
      run: |
        mkdir -p ios_build
        cat > ios_build/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDisplayName</key>
            <string>Avventura Epica</string>
            <key>CFBundleExecutable</key>
            <string>AvventuraEpica</string>
            <key>CFBundleIdentifier</key>
            <string>com.ambro86.avventuraepica</string>
            <key>CFBundleName</key>
            <string>AvventuraEpica</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSRequiresIPhoneOS</key>
            <true/>
            <key>UILaunchStoryboardName</key>
            <string>LaunchScreen</string>
            <key>UIRequiredDeviceCapabilities</key>
            <array>
                <string>armv7</string>
            </array>
            <key>UISupportedInterfaceOrientations</key>
            <array>
                <string>UIInterfaceOrientationPortrait</string>
                <string>UIInterfaceOrientationLandscapeLeft</string>
                <string>UIInterfaceOrientationLandscapeRight</string>
            </array>
            <key>UIAccessibilityTraits</key>
            <string>UIAccessibilityTraitPlaysSound</string>
            <key>UIAccessibilityLanguage</key>
            <string>it</string>
            <key>NSMicrophoneUsageDescription</key>
            <string>Questa app usa l'audio per l'accessibilit√†</string>
        </dict>
        </plist>
        EOF
    
    - name: Build Flet iOS project (unsigned)
      run: |
        echo "Building unsigned iOS app with Flet..."
        flet pack ios ${{ env.MAIN_FILE }} --name AvventuraEpica --bundle-id com.ambro86.avventuraepica --no-codesign
    
    - name: Package into IPA
      run: |
        echo "Packaging .app into .ipa..."

        mkdir -p Payload
        cp -R dist/ios/*.app Payload/
        chmod -R +x Payload/AvventuraEpica.app || true

        zip -r AvventuraEpica-iOS.ipa Payload/
        echo "‚úÖ IPA packaged: AvventuraEpica-iOS.ipa"

    - name: Verify IPA structure
      run: |
        echo "üîç Verifying IPA structure..."
        unzip -l AvventuraEpica-iOS.ipa | head -20

        if unzip -l AvventuraEpica-iOS.ipa | grep -q "Info.plist"; then
          echo "‚úÖ Info.plist found in IPA"
        else
          echo "‚ùå Info.plist missing from IPA"
        fi
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: AvventuraEpica-iOS
        path: |
          AvventuraEpica-iOS.ipa
          Payload/
        retention-days: 30
