name: Build iOS App

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Flet
      run: |
        pip install flet flet-audio pyinstaller
        
    - name: Find main file
      run: |
        if [ -f "gioco.py" ]; then
          echo "MAIN_FILE=gioco.py" >> $GITHUB_ENV
        elif [ -f "main.py" ]; then
          echo "MAIN_FILE=main.py" >> $GITHUB_ENV
        else
          echo "MAIN_FILE=avventura_epica.py" >> $GITHUB_ENV
        fi
        
    - name: Verify assets
      run: |
        echo "Checking for existing assets..."
        if [ -d "assets" ]; then
          echo "Assets folder found:"
          find assets -name "*.wav" -o -name "*.mp3" | sort
          AUDIO_COUNT=$(find assets -name "*.wav" -o -name "*.mp3" | wc -l)
          echo "Total audio files: $AUDIO_COUNT"
        else
          echo "No assets folder found, creating minimal structure..."
          mkdir -p assets
          for i in {1..18}; do touch "assets/$i.wav"; done
          echo "Created placeholder files 1.wav to 18.wav"
        fi
        
    - name: Build iOS
      run: |
        echo "Building iOS app with Flet..."
        # Installa dipendenze per iOS se necessarie
        pip install --upgrade setuptools wheel
        
        # Build per iOS - Flet 0.28.3 potrebbe usare sintassi diversa
        flet pack gioco.py --name AvventuraEpica || flet build ios gioco.py --name AvventuraEpica
        
    - name: Create IPA
      run: |
        mkdir -p build/Payload
        cp -R dist/*.app build/Payload/ || cp -R *.app build/Payload/
        cd build && zip -r AvventuraEpica.ipa Payload/
        mkdir -p ../artifacts && mv AvventuraEpica.ipa ../artifacts/
        
    - name: Create guide
      run: |
        mkdir -p artifacts
        cd artifacts
        echo "Avventura Epica iOS app ready for installation" > README.txt
        
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: ios-app
        path: artifacts/