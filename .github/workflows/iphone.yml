name: Build iOS App

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Flet
      run: |
        pip install flet flet-audio
        
    - name: Find main file
      run: |
        if [ -f "gioco.py" ]; then
          echo "MAIN_FILE=gioco.py" >> $GITHUB_ENV
        elif [ -f "main.py" ]; then
          echo "MAIN_FILE=main.py" >> $GITHUB_ENV
        else
          echo "MAIN_FILE=avventura_epica.py" >> $GITHUB_ENV
        fi
        
    - name: Verify assets
      run: |
        echo "Checking for existing assets..."
        if [ -d "assets" ]; then
          echo "Assets folder found:"
          find assets -name "*.wav" -o -name "*.mp3" | sort
          AUDIO_COUNT=$(find assets -name "*.wav" -o -name "*.mp3" | wc -l)
          echo "Total audio files: $AUDIO_COUNT"
        else
          echo "No assets folder found, creating minimal structure..."
          mkdir -p assets
          for i in {1..18}; do touch "assets/$i.wav"; done
          echo "Created placeholder files 1.wav to 18.wav"
        fi
        
    - name: Build iOS
      run: |
        echo "Building iOS app with Flet..."
        flet pack $MAIN_FILE \
          --name AvventuraEpica \
          --platform ios \
          --no-sign \
          --add-data "assets:assets" \
          --include-packages flet-audio
        
    - name: Create IPA
      run: |
        mkdir -p build/Payload
        cp -R dist/*.app build/Payload/ || cp -R *.app build/Payload/
        cd build && zip -r AvventuraEpica.ipa Payload/
        mkdir -p ../artifacts && mv AvventuraEpica.ipa ../artifacts/
        
    - name: Create guide
      run: |
        mkdir -p artifacts
        cd artifacts
        cat > INSTALL_GUIDE.txt << 'EOF'
# Avventura Epica iOS - Guida Installazione

App Info:
- Nome: Avventura Epica
- Tipo: RPG Testuale con Audio e Haptic
- Framework: Flet (Python â†’ iOS nativo)
- Compatibilita: iOS 14.0+ (iPhone/iPad)

Installazione con AltStore:
1. Scarica AvventuraEpica.ipa
2. Apri AltStore su iPhone
3. Tocca + e seleziona il file .ipa
4. Inserisci Apple ID quando richiesto
5. Attendi installazione
6. Autorizza in Impostazioni > Gestione dispositivi

Caratteristiche del Gioco:
- 16 aree da esplorare
- Sistema RPG con livelli
- Audio dinamico e haptic feedback
- Negozi e inventario
- Compatible con VoiceOver

Note:
- App scade dopo 7 giorni (account gratuito)
- Rinnovo necessario tramite AltStore
- Richiede iOS 14.0 o superiore

Buona avventura!
EOF
        
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: ios-app
        path: artifacts/