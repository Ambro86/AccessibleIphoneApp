name: Build iOS App

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Xcode Command Line Tools
      run: |
        sudo xcode-select --install || true
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer || true
    
    - name: Install Flet and dependencies
      run: |
        pip install flet flet-audio pyinstaller
        pip install --upgrade setuptools wheel
    
    - name: Detect main file
      run: |
        if [ -f "gioco.py" ]; then
          echo "MAIN_FILE=gioco.py" >> $GITHUB_ENV
        elif [ -f "main.py" ]; then
          echo "MAIN_FILE=main.py" >> $GITHUB_ENV
        else
          echo "MAIN_FILE=avventura_epica.py" >> $GITHUB_ENV
        fi
    
    - name: Check assets
      run: |
        echo "Checking for existing assets..."
        if [ -d "assets" ]; then
          echo "Assets folder found:"
          find assets -name "*.wav" -o -name "*.mp3" | sort
          AUDIO_COUNT=$(find assets -name "*.wav" -o -name "*.mp3" | wc -l)
          echo "Total audio files: $AUDIO_COUNT"
        else
          echo "No assets folder found, creating minimal structure..."
          mkdir -p assets
          for i in {1..18}; do touch "assets/$i.wav"; done
          echo "Created placeholder files 1.wav to 18.wav"
        fi
    
    - name: Create Info.plist
      run: |
        mkdir -p ios_build
        cat > ios_build/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDisplayName</key>
            <string>Avventura Epica</string>
            <key>CFBundleExecutable</key>
            <string>AvventuraEpica</string>
            <key>CFBundleIdentifier</key>
            <string>com.ambro86.avventuraepica</string>
            <key>CFBundleName</key>
            <string>AvventuraEpica</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSRequiresIPhoneOS</key>
            <true/>
            <key>UILaunchStoryboardName</key>
            <string>LaunchScreen</string>
            <key>UIRequiredDeviceCapabilities</key>
            <array>
                <string>armv7</string>
            </array>
            <key>UISupportedInterfaceOrientations</key>
            <array>
                <string>UIInterfaceOrientationPortrait</string>
                <string>UIInterfaceOrientationLandscapeLeft</string>
                <string>UIInterfaceOrientationLandscapeRight</string>
            </array>
            <key>UIAccessibilityTraits</key>
            <string>UIAccessibilityTraitPlaysSound</string>
            <key>UIAccessibilityLanguage</key>
            <string>it</string>
            <key>NSMicrophoneUsageDescription</key>
            <string>Questa app usa l'audio per l'accessibilit√†</string>
        </dict>
        </plist>
        EOF
    
    - name: Build with Flet
      run: |
        echo "Creating Flet iOS project..."
        
        # Prova diversi approcci per iOS
        if flet build ios $MAIN_FILE --name AvventuraEpica --bundle-id com.ambro86.avventuraepica; then
          echo "‚úÖ Flet build ios successful"
        elif flet pack $MAIN_FILE --name AvventuraEpica --add-data "assets:assets"; then
          echo "‚úÖ Flet pack successful"
        else
          echo "‚ùå Both flet commands failed, creating manual structure"
          # Crea struttura manuale
          mkdir -p build/ios/AvventuraEpica.app
          cp $MAIN_FILE build/ios/AvventuraEpica.app/
          cp -r assets build/ios/AvventuraEpica.app/ 2>/dev/null || true
          cp ios_build/Info.plist build/ios/AvventuraEpica.app/
        fi
    
    - name: Create IPA structure
      run: |
        echo "Creating IPA package structure..."
        
        # Debug: vedi cosa ha creato Flet
        echo "üîç Checking build directories:"
        ls -la
        [ -d "build" ] && echo "Build directory:" && find build -type f -name "*" | head -10
        [ -d "dist" ] && echo "Dist directory:" && find dist -type f -name "*" | head -10
        
        # Crea struttura IPA
        mkdir -p Payload/AvventuraEpica.app
        
        # Copia sempre manualmente per sicurezza
        echo "üìã Creating app bundle manually..."
        
        # Copia il file Python principale
        cp $MAIN_FILE Payload/AvventuraEpica.app/
        
        # Copia gli assets se esistono
        if [ -d "assets" ]; then
          cp -r assets Payload/AvventuraEpica.app/
          echo "‚úÖ Assets copied"
        fi
        
        # Copia il binary di Flet se esiste
        if [ -f "dist/AvventuraEpica" ]; then
          cp dist/AvventuraEpica Payload/AvventuraEpica.app/
          echo "‚úÖ Flet binary copied"
        elif [ -f "dist/AvventuraEpica.app/Contents/MacOS/AvventuraEpica" ]; then
          cp "dist/AvventuraEpica.app/Contents/MacOS/AvventuraEpica" Payload/AvventuraEpica.app/
          echo "‚úÖ macOS app binary copied"
        else
          # Crea un eseguibile dummy
          cat > Payload/AvventuraEpica.app/AvventuraEpica << 'EOF'
#!/bin/bash
python3 gioco.py
EOF
          chmod +x Payload/AvventuraEpica.app/AvventuraEpica
          echo "‚ö†Ô∏è Created dummy executable"
        fi
        
        # Copia Info.plist
        cp ios_build/Info.plist Payload/AvventuraEpica.app/
        echo "‚úÖ Info.plist copied"
        
        # Verifica contenuto prima di zippare
        echo "üìÇ App bundle contents:"
        if [ -d "Payload/AvventuraEpica.app" ]; then
          ls -la Payload/AvventuraEpica.app/
        else
          echo "‚ùå App bundle directory not found!"
          ls -la Payload/
        fi
        
        # Crea il file IPA
        zip -r AvventuraEpica-iOS.ipa Payload/
        
        echo "üì± IPA created: AvventuraEpica-iOS.ipa"
        ls -lh AvventuraEpica-iOS.ipa
    
    - name: Verify IPA structure
      run: |
        echo "üîç Verifying IPA structure..."
        unzip -l AvventuraEpica-iOS.ipa | head -20
        
        # Verifica Info.plist
        if unzip -l AvventuraEpica-iOS.ipa | grep -q "Info.plist"; then
          echo "‚úÖ Info.plist found in IPA"
        else
          echo "‚ùå Info.plist missing from IPA"
        fi
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: AvventuraEpica-iOS
        path: |
          AvventuraEpica-iOS.ipa
          Payload/
        retention-days: 30
 
 